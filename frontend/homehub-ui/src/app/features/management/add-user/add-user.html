<div class="modal-overlay" (click)="cancel()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">–î–æ–±–∞–≤–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</h2>
      <button class="close-button" (click)="cancel()">&times;</button>
    </div>

    <div class="modal-body">
      @if (loading()) {
        <div class="loading-spinner">
          <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
        </div>
      } @else {
        @if (errorMessage()) {
          <app-error-message [errorMessage]="errorMessage()" (close)="closeError()" />
        }

        <form class="add-user-form" [formGroup]="registerForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label for="add-user-firstName">–ü—ä—Ä–≤–æ –∏–º–µ</label>
              <input type="text" id="add-user-firstName" formControlName="firstName"
                [class.error]="registerForm.get('firstName')?.invalid && registerForm.get('firstName')?.touched">
              @if (registerForm.get('firstName')?.invalid && registerForm.get('firstName')?.touched) {
                <div class="validator-error-message">
                  @if (registerForm.get('firstName')?.errors?.['required']) {
                    <small>–ü—ä—Ä–≤–æ—Ç–æ –∏–º–µ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ.</small>
                  }
                  @if (registerForm.get('firstName')?.errors?.['minlength']) {
                    <small>–ü—ä—Ä–≤–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 3 —Å–∏–º–≤–æ–ª–∞.</small>
                  }
                  @if (registerForm.get('firstName')?.errors?.['maxlength']) {
                    <small>–ü—ä—Ä–≤–æ—Ç–æ –∏–º–µ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø–æ-–¥—ä–ª–≥–æ –æ—Ç 64 —Å–∏–º–≤–æ–ª–∞.</small>
                  }
                </div>
              }
            </div>
            <div class="form-group">
              <label for="add-user-lastName">–§–∞–º–∏–ª–∏—è</label>
              <input type="text" id="add-user-lastName" formControlName="lastName"
                [class.error]="registerForm.get('lastName')?.invalid && registerForm.get('lastName')?.touched">
              @if (registerForm.get('lastName')?.invalid && registerForm.get('lastName')?.touched) {
                <div class="validator-error-message">
                  @if (registerForm.get('lastName')?.errors?.['required']) {
                    <small>–§–∞–º–∏–ª–∏—è—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞.</small>
                  }
                  @if (registerForm.get('lastName')?.errors?.['minlength']) {
                    <small>–§–∞–º–∏–ª–∏—è—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 3 —Å–∏–º–≤–æ–ª–∞.</small>
                  }
                  @if (registerForm.get('lastName')?.errors?.['maxlength']) {
                    <small>–§–∞–º–∏–ª–∏—è—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø–æ-–¥—ä–ª–≥–∞ –æ—Ç 64 —Å–∏–º–≤–æ–ª–∞.</small>
                  }
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="add-user-email">–ò–º–µ–π–ª –∞–¥—Ä–µ—Å</label>
              <input type="email" id="add-user-email" formControlName="email"
                [class.error]="registerForm.get('email')?.invalid && registerForm.get('email')?.touched">
              @if (registerForm.get('email')?.invalid && registerForm.get('email')?.touched) {
                <div class="validator-error-message">
                  @if (registerForm.get('email')?.errors?.['required']) {
                    <small>–ò–º–µ–π–ª –∞–¥—Ä–µ—Å—ä—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω.</small>
                  }
                  @if (registerForm.get('email')?.errors?.['email']) {
                    <small>–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∏–º–µ–π–ª —Ñ–æ—Ä–º–∞—Ç.</small>
                  }
                </div>
              }
            </div>
            <div class="form-group">
              <label for="add-user-familyRole">–†–æ–ª—è –≤ —Å–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ</label>
              <select id="add-user-familyRole" formControlName="familyRole"
                      [class.error]="registerForm.get('familyRole')?.invalid && registerForm.get('familyRole')?.touched">
                <option value="" disabled selected>–ò–∑–±–µ—Ä–∏ —Ä–æ–ª—è –≤ —Å–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ</option>
                @for (role of familyRoleOptions(); track role.value) {
                  <option [value]="role.value">{{ role.label }}</option>
                }
              </select>
              @if (registerForm.get('familyRole')?.invalid && registerForm.get('familyRole')?.touched) {
                <div class="validator-error-message">
                  @if (registerForm.get('familyRole')?.errors?.['required']) {
                    <small>–†–æ–ª—è—Ç–∞ –≤ —Å–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞.</small>
                  }
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="add-user-password">–ü–∞—Ä–æ–ª–∞</label>
              <input type="password" id="add-user-password" formControlName="password"
                [class.error]="registerForm.get('password')?.invalid && registerForm.get('password')?.touched"
                (input)="checkPasswordMatch()">
              @if (registerForm.get('password')?.invalid && registerForm.get('password')?.touched) {
                <div class="validator-error-message">
                  @if (registerForm.get('password')?.errors?.['required']) {
                    <small>–ü–∞—Ä–æ–ª–∞—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞.</small>
                  }
                  @if (registerForm.get('password')?.errors?.['minlength']) {
                    <small>–ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 4 —Å–∏–º–≤–æ–ª–∞.</small>
                  }
                  @if (registerForm.get('password')?.errors?.['maxlength']) {
                    <small>–ü–∞—Ä–æ–ª–∞—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø–æ-–¥—ä–ª–≥–∞ –æ—Ç 16 —Å–∏–º–≤–æ–ª–∞.</small>
                  }
                </div>
              }
            </div>
            <div class="form-group">
              <label for="add-user-confirm">–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª–∞</label>
              <input type="password" id="add-user-confirm" formControlName="confirmPassword"
                [class.error]="registerForm.get('confirmPassword')?.invalid && registerForm.get('confirmPassword')?.touched"
                [class.success]="passwordsMatch() && registerForm.get('confirmPassword')?.value"
                (input)="checkPasswordMatch()">
              @if (registerForm.get('confirmPassword')?.invalid && registerForm.get('confirmPassword')?.touched) {
                <div class="validator-error-message">
                  @if (registerForm.get('confirmPassword')?.errors?.['required']) {
                    <small>–ü–æ–≤—Ç–æ—Ä–µ—Ç–µ –ø–∞—Ä–æ–ª–∞—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∞.</small>
                  }
                  @if (!passwordsMatch() && registerForm.get('confirmPassword')?.touched) {
                    <small>–ü–∞—Ä–æ–ª–∏—Ç–µ –Ω–µ —Å—ä–≤–ø–∞–¥–∞—Ç.</small>
                  }
                </div>  
              }
            </div>
          </div>

          <div class="form-group">
            <label for="add-user-description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="add-user-description" formControlName="description" rows="3"
              [class.error]="registerForm.get('description')?.invalid && registerForm.get('description')?.touched">
            </textarea>
            @if (registerForm.get('description')?.invalid && registerForm.get('description')?.touched) {
              <div class="validator-error-message">
                @if (registerForm.get('description')?.errors?.['required']) {
                  <small>–û–ø–∏—Å–∞–Ω–∏–µ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ.</small>
                }
                @if (registerForm.get('description')?.errors?.['minlength']) {
                  <small>–û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 10 —Å–∏–º–≤–æ–ª–∞.</small>
                }
                @if (registerForm.get('description')?.errors?.['maxlength']) {
                  <small>–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø–æ-–¥—ä–ª–≥–æ –æ—Ç 256 —Å–∏–º–≤–æ–ª–∞.</small>
                }
              </div>
            }
          </div>

          <div class="form-group">
            <label for="profile-image">–ü—Ä–æ—Ñ–∏–ª–Ω–∞ —Å–Ω–∏–º–∫–∞</label>
            <div class="file-upload">
              <input type="file" id="profile-image" accept="image/*" (change)="onFileChange($event)">
              <label for="profile-image" class="file-label" [class.has-file]="fileName()">
                <span class="upload-icon">üì∑</span>
                <span class="upload-text">{{ fileName() || '–ò–∑–±–µ—Ä–∏ —Å–Ω–∏–º–∫–∞' }}</span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="add-user-familyId">–°–µ–º–µ–π—Å—Ç–≤–æ</label>
            @if (!!families() && families()!.length > 0) {
              <select id="add-user-familyId" formControlName="familyId"
                      [class.error]="registerForm.get('familyId')?.invalid && registerForm.get('familyId')?.touched">
                <option value="" disabled selected>–ò–∑–±–µ—Ä–∏ —Å–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ</option>
                @for (family of families(); track family.id) {
                  <option [value]="family.id">{{ family.name }}</option>
                }
              </select>
            } @else {
              <div>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–µ–º–µ–π—Å—Ç–≤–∞...</div>
            }
            @if (registerForm.get('familyId')?.invalid && registerForm.get('familyId')?.touched) {
              <div class="validator-error-message">
                @if (registerForm.get('familyId')?.errors?.['required']) {
                  <small>–°–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ.</small>
                }
              </div>
            }
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="cancel()">
              –û—Ç–∫–∞–∑
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="loading()">
              {{ buttonText() }}
            </button>
          </div>
        </form>
      }
    </div>
  </div>
</div>
