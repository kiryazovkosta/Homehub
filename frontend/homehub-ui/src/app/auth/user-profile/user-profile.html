<section id="user-profile" class="form-section">
    <div class="container">

        <div class="section-header">
            <h2 class="gradient-text">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏ –ø—Ä–æ—Ñ–∏–ª</h2>
            <p>–£–ø—Ä–∞–≤–ª—è–≤–∞–π—Ç–µ –≤–∞—à–∏—è –ø—Ä–æ—Ñ–∏–ª –∏ –ª–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
        </div>
        <div class="form-container">

            @if (loading()) {
            <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
            }
            @else {
            <form class="contact-form" [formGroup]="userProfileForm" (ngSubmit)="onSubmit()">
                <!-- Personal Information -->
                <div class="form-section-title">
                    <h3>–õ–∏—á–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <input type="hidden" formControlName="id" />
                    <app-error-message [errorMessage]="errorMessage()" (close)="closeError()" />
                </div>

                <div class="form-group">
                    <label for="user-profile-imageUrl">–°–Ω–∏–º–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞</label>
                    <div class="profile-image-container">
                        @if (hasProfileImage()) {
                            <img [src]="profileImageUrl()" alt="Profile Image" class="profile-image">
                        } @else {
                            <div class="no-image-placeholder">
                                <span class="no-image-icon">üë§</span>
                                <p>–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∞ —Å–Ω–∏–º–∫–∞</p>
                            </div>
                        }
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="user-profile-firstName">–õ–∏—á–Ω–æ –∏–º–µ *</label>
                        <input type="text" id="user-profile-firstName" formControlName="firstName" [readonly]="!editMode()" 
                        [class.error]="userProfileForm.get('firstName')?.invalid && userProfileForm.get('firstName')?.touched">
                        @if (editMode() && userProfileForm.get('firstName')?.invalid && userProfileForm.get('firstName')?.touched) {
                            <div class="validator-error-message">
                              @if (userProfileForm.get('firstName')?.errors?.['required']) {
                                <small>–õ–∏—á–Ω–æ—Ç–æ –∏–º–µ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ.</small>
                              }
                              @if (userProfileForm.get('firstName')?.errors?.['minlength']) {
                                <small>–õ–∏—á–Ω–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 3 —Å–∏–º–≤–æ–ª–∞.</small>
                              }
                              @if (userProfileForm.get('firstName')?.errors?.['maxlength']) {
                                <small>–õ–∏—á–Ω–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –Ω–∞–π-–º–Ω–æ–≥–æ 64 —Å–∏–º–≤–æ–ª–∞.</small>
                              }
                            </div>
                          }
                    </div>
                    <div class="form-group">
                        <label for="user-profile-lastName">–§–∞–º–∏–ª–Ω–æ –∏–º–µ *</label>
                        <input type="text" id="user-profile-lastName" formControlName="lastName"
                            [readonly]="!editMode()" [class.error]="userProfileForm.get('lastName')?.invalid && userProfileForm.get('lastName')?.touched">
                            @if (editMode() && userProfileForm.get('lastName')?.invalid && userProfileForm.get('lastName')?.touched) {
                            <div class="validator-error-message">
                                @if (userProfileForm.get('lastName')?.errors?.['required']) {
                                    <small>–§–∞–º–∏–ª–Ω–æ—Ç–æ –∏–º–µ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ.</small>
                                }
                                @if (userProfileForm.get('lastName')?.errors?.['minlength']) {
                                    <small>–§–∞–º–∏–ª–Ω–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 3 —Å–∏–º–≤–æ–ª–∞.</small>
                                }
                                @if (userProfileForm.get('lastName')?.errors?.['maxlength']) {
                                <small>–§–∞–º–∏–ª–Ω–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –Ω–∞–π-–º–Ω–æ–≥–æ 64 —Å–∏–º–≤–æ–ª–∞.</small>
                                }
                            </div>
                            }
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="user-profile-email">–ò–º–µ–π–ª</label>
                        <input type="text" id="user-profile-email" formControlName="email" readonly>
                    </div>
                    <div class="form-group">
                        <label for="user-profile-familyRoleValue">–†–æ–ª—è –≤ —Å–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ *</label>

                        @if (!editMode()) {
                        <input type="text" id="user-profile-familyRoleValue" formControlName="familyRoleValue" readonly>
                        } @else {
                        <select id="user-profile-familyRole" formControlName="familyRole">
                            @for (role of familyRoles(); track role[0]) {
                            <option [value]="role[0]">{{ role[1] }}</option>
                            }
                        </select>
                        }

                    </div>
                </div>

                <div class="form-group">
                    <label for="user-profile-description">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                    <textarea type="text" id="user-profile-description" formControlName="description"
                        [readonly]="!editMode()" rows="3"></textarea>
                </div>

                <!-- File Upload -->
                <div class="form-group">
                    <label for="user-profile-file">–ü—Ä–∏–∫–∞—á–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ</label>
                    <div class="file-upload">
                        <input type="file" id="user-profile-file" multiple accept=".jpg,.png,.jpeg"
                            (change)="onFilesChange($event)" [disabled]="!editMode()">
                        <label for="user-profile-file" class="file-label" [class.has-file]="selectedFile()">
                            <span class="upload-icon">üìé</span>
                            <span class="upload-text">{{ fileUploadText() }}</span>
                        </label>
                    </div>
                </div>

                <div class="form-row" formGroupName="familyGroup">
                    <div class="form-group">
                        <label for="user-profile-familyName">–°–µ–º–µ–π—Å—Ç–≤–æ</label>
                        <input type="text" id="user-profile-familyName" formControlName="familyName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="user-profile-familyDescription">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–º–µ–π—Å—Ç–≤–æ—Ç–æ</label>
                        <input type="text" id="user-profile-familyDescription" formControlName="familyDescription"
                            readonly>
                    </div>
                </div>

                <div class="form-actions">
                    @if (editMode()) {
                    <button type="submit" class="btn btn-primary" [disabled]="loading()">–ó–∞–ø–∞–∑–∏</button>
                    <button type="button" class="btn btn-secondary" (click)="cancelEdit()">–û—Ç–∫–∞–∑</button>
                    } @else {
                    <button type="button" class="btn btn-primary" [disabled]="editMode()" (click)="enableEditMode()">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ</button>
                    }
                </div>
            </form>
            }
        </div>
    </div>
</section>